---
title: 서버조교 기록
comments: true
---

## Port는 Open되었으나 Ping은 잡히지 않는다

브라우저에서 서버의 ip주소를 치고 바로 들어갈 수 있는 JupyterHub를 만드는 것이 목표이다. 그러나 과정은 정말 어려웠고 아직까지도 성공하지 못했다. 다만 원인은 어느 정도 발견된 것 같아 이에 대한 해결을 앞으로 해보고자 한다. 지금까지 주피터 허브용 서버를 만들기 위해 사용했던 방법들, 참고했던 링크들을 적어본다.

### 1)  JupyterHub Documentation

The littlest JupyterHub 라는 아주 쉽게 설치하는 방법도 존재했지만, 이는 `Ubuntu 18.04` 이상에서만 설치가 가능하였기 때문에, `CentOS 7`을 쓰고있는 리눅스 서버에서는 사용할 수 없는 방법이었다. 어쩔 수 없이 [여기](https://jupyterhub.readthedocs.io/en/stable/installation-guide-hard.html)에서 'from the ground up', 즉 처음부터 전부 쌓아올리는 방식으로 시작하였다.

리눅스 명령에는 아직 익숙치 않아서, 이해하지는 못해도 하라는대로 다 따라했다. 하다가 'Setup Systemd service' 부분에서, 너의 `favourite editor`를 사용하여 텍스트를 집어넣으라고 하는 부분이 어려웠다. text editor를 사용해본 경험이 없었기 때문에.. 그래서 가장 단순한 `sudo vi ` 명령을 사용하여 파일을 만들었고, 해당 부분에 필요한 텍스트를 붙여넣기한 후, `esc`를 누르고 `:wq!` 를 통해 빠져나왔다. 

두 번째 난관은 `conda`를 인스톨하는데에서 발생하였다. [여기](https://docs.conda.io/projects/conda/en/latest/user-guide/install/rpm-debian.html)에서 하라는대로 했지만, anaconda repository를 추가하는 명령어가 계속 '허가 거부'를 띄우며 실패했기 때문이다. 결국에는 `conda.repo`라는 텍스트 파일을 직접 `touch`하여 만들고, 위에서와 마찬가지로 `sudo vi`를 통해 빈 텍스트 파일에 필요한 텍스트를 붙여넣은 후 빠져나옴으로써 문제를 해결할 수 있었다. 

이후의 모든 과정들은 비교적 순조롭게 잘 진행되었다. `Nginx`를 설정하는 과정에서 `/etc/nginx/sites-available`이라는 폴더를 찾지 못해 당황하였지만, 구글링해본 결과 [갓택오버플로우](https://stackoverflow.com/questions/17413526/nginx-missing-sites-available-directory)에서 그냥 폴더 만들고 필요한 것들을 집어넣어주면 된다길래 무식하게 따라했다. 하라는대로 인스톨을 다하고, documentation에서 말하는대로 `ip주소/jupyter`를 통해 들어가보려 하니, 로딩만 오지게 하더니 결국 접속이 안된다는 무책임한(?) 브라우저의 답변을 보게 되었다.

### 2)  왜 접속이 안되지? - 방화벽 확인

방화벽에 가로막힌 것은 아닐까 하고 확인해보았다. 처음에는 무식하게 방화벽을 잠깐 해제하는 방식으로 해보았다. 방화벽을 해제하는 방법은 [여기](https://realforce111.tistory.com/24)를 참고했다. `sudo systemctl stop firewalld`를 통해 잠깐 방화벽을 비활성화한 후, ip주소를 쳐서 들어가보니 'CentOS' 어쩌구 하며 뭔가 나오긴 했다. 근데 이건 내가 원하던 주피터 서버가 아니었다. 그리고 뒤늦게 안 사실이지만, 이렇게 브라우저로 접속이 되는 것도 내 노트북이 학교 내의 Wifi에 연결되어있었기 때문에 가능했다.

왜냐? 집에 와서 마찬가지로 방화벽을 해제하고 들어가보려 했지만 안됐기 때문이다. 

### 3) 왜 접속이 안되지? - 포트포워딩 ?

어떤 사람이 커뮤니티에 남긴 글이 나의 처지와 비슷하여, 댓글들을 보니, 내부에서 접속이 안되는 것은 방확벽의 문제고, 외부에서 접속이 안되는 것은 포트포워딩의 문제라는 글을 보았다. 방화벽은 해제하니까 내부접속은 됐고, 그럼 포트포워딩의 문제인가보다!!!! 하면서 포트포워딩에 대해서 찾기 시작했다. [이 곳](https://m.blog.naver.com/unjerry/221288444909)에서 포트포워딩에 대해 쉽게 설명해놓았다. 즉, 외부에서 서버에 접속하려 할 때, 서버가 공유기에 연결되어 있다면, 공유기에 접속된 수많은 컴퓨터/노트북/다양한 기기들 가운데 어떤 놈한테 연결해줄지를 정해준다는 것이다.

근데.. 생각해보니 우리 서버는 공유기를 통하긴 하지만, 이미 자체적으로 고유 ip를 갖고 있다. 즉, 공유기에 연결된 `192.168.0.x`의 형식으로 존재하지 않는다는 것이다. 이미 `ssh`로는 접속이 잘 되고 있었다는 것이 이를 증명해주고 있었다. 근데 어쨌든 이것 저것 찾아서 포트포워딩을 해주긴 했다. (올바르게 했는지는 모르겠다.) 

### 4) 왜 접속이 안되지? - 학교 내부망?

그럼 도대체 무엇이 문제일까.. 방화벽에서 `sudo firewall-cmd --add-forward-port` 명령을 통해 포트포워딩도 했겠다, `sudo firewall-cmd --add-service`를 통해 `http`, `https`, `ssh` 다 설정해주었겠다, `sudo firewall-cmd --add-port`를 통해 `443`, `80`, `8000` 포트도 열어줬겠다.. 뭘 더 해야하는지 감이 잡히지 않았고, 여전히 서버는 외부에서 접속할 수 없었다.

순간 스쳐간 생각은, 어쨌든 리눅스 서버가 학교 망을 통해 들어오고 있으니까 학교측에서 `http` 접속을 원천 차단해버리는 것이 아닐까 하는 생각이었다. 이를 확인해보기 위한 실험으로 `ping`을 날려보았다. `ping`을 날리는 것은 곧 해당 서버 - 해당 포트에 문을 똑똑 두드리는 것과 같다. `ping`에 대한 `response`로 수신되는 데이터가 있다면, 이는 곧 문을 두드렸을 때 "네 ~" 하는 것과 같다고 한다. 

① 내부/외부에서 ping 날리기 : 먼저, 학교 Wifi로 접속하여 서버 ip로 ping을 날려보았다. 잘 받아왔다. 그 다음, 핸드폰의 핫스팟에 연결하여 동일하게 해당 ip로 ping을 날려보았다. 안 된다. 즉, 내부와 외부에서 ping을 날렸을 때 response가 달라짐을 확인하였다.

② 외부에서 ssh(22번 포트) / http(80번 포트) 에 ping 날리기 : 학교 내부 ip에 접속한 상태에서는 ping이 잘 response 되는 것을 확인했다. 근데 생각해보니 `ssh`는 우리 집에서도 잘 접속되지 않았던가? 그래서 외부에서 각각 다른 포트에 ping을 날려보았다. `tcping`을 다운로드 받아 `cmd`에서 ping을 날리면 원하는 포트에다가 ping을 날릴 수 있다. 날려본 결과, 22번 포트(ssh)에서는 ping이 잘 수신됨을 확인하였고, 80번 포트(http)에서는 ping이 수신되지 않았다. 22번 이외의 다른 모든 포트에서도 response가 없었다.

### 5) 소결(아직 결론은 아니지만)

여전히 문제는 해결되지 않았지만, 어느 정도 원인은 확실해진 것 같다. 내부 접속은 되지만, 외부 접속은 안되고, 외부에서도 `ssh`는 허용하지만 `http`는 허용하지 않는다. 이는 아무래도 학교망의 문제인 것 같다. 조만간 학교 전산실에 연락해서 이것이 사실인지 확인해볼 예정이다.